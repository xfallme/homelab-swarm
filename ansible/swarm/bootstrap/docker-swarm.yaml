- name: Configure Docker Swarm (Master on swarm01)
  hosts: swarm01
  become: true
  
  tasks:
    - name: Dependencies (pip & docker SDK)
      apt:
        name: 
          - python3-pip
          - python3-docker
        state: present

    - name: Initialize Docker Swarm
      docker_swarm:
        state: present
        advertise_addr: "{{ ansible_host }}"
      register: swarm_init

    - name: Set fact for join token
      set_fact:
        manager_join_token: "{{ swarm_init.swarm_facts.JoinTokens.Manager }}"

- name: Join Docker Swarm
  hosts: swarm02:swarm03
  become: true

  tasks:
    - name: Dependencies (pip & docker SDK)
      apt:
        name: 
          - python3-pip
          - python3-docker
        state: present

    - name: Join Docker Swarm
      docker_swarm:
        state: join
        join_token: "{{ hostvars['swarm01'].manager_join_token }}"
        remote_addrs: "{{ hostvars['swarm01'].ansible_host }}"